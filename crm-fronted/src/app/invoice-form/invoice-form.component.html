<div class="invoice-form">
  <h2>{{ invoice.id ? 'ویرایش فاکتور' : 'ایجاد فاکتور جدید' }}</h2>

  <form (ngSubmit)="save()">
    <!-- شماره فاکتور -->
    <label>شماره فاکتور:</label>
    <input type="text" [(ngModel)]="invoice.invoiceNumber" name="invoiceNumber" required>

    <!-- نوع فاکتور -->
    <label>نوع فاکتور:</label>
    <select [(ngModel)]="invoice.invoiceType" name="invoiceType" (change)="onValidityDaysChange()">
      <option value="Proforma">پیش‌فاکتور</option>
      <option value="Invoice">فاکتور</option>
    </select>

    <!-- تعداد روز اعتبار برای پیش‌فاکتور -->
    <div *ngIf="invoice.invoiceType === 'Proforma'">
      <label>تعداد روز اعتبار:</label>
      <input type="number"
             [(ngModel)]="validityDays"
             name="validityDays"
             min="1"
             (input)="onValidityDaysChange()">
      <div *ngIf="dueDateShamsi">
        <small>تاریخ اعتبار: {{ dueDateShamsi }}</small>
      </div>
    </div>

    <!-- وضعیت فاکتور -->
    <label>وضعیت فاکتور:</label>
    <select [(ngModel)]="invoice.status" name="status" required>
      <option value="Draft">پیش‌نویس</option>
      <option value="Sent">ارسال شده</option>
      <option value="Paid">پرداخت شده</option>
      <option value="Cancelled">لغو شده</option>
    </select>

    <!-- انتخاب نوع مشتری -->
    <div class="customer-type">
      <label>
        <input type="radio" name="customerType" value="individual"
               [(ngModel)]="selectedCustomerType"
               (change)="onCustomerTypeChange('individual')"> مشتری حقیقی
      </label>
      <label>
        <input type="radio" name="customerType" value="company"
               [(ngModel)]="selectedCustomerType"
               (change)="onCustomerTypeChange('company')"> مشتری حقوقی
      </label>
    </div>

    <!-- انتخاب مشتری حقیقی -->
    <div *ngIf="selectedCustomerType === 'individual'">
      <label>انتخاب مشتری حقیقی:</label>
      <select [(ngModel)]="invoice.customerIndividualId" name="customerIndividualId">
        <option [ngValue]="null">انتخاب کنید</option>
        <option *ngFor="let c of customersIndividual" [ngValue]="c.customerId">
          {{ c.fullName }}
        </option>
      </select>
    </div>

    <!-- انتخاب مشتری حقوقی -->
    <div *ngIf="selectedCustomerType === 'company'">
      <label>انتخاب مشتری حقوقی:</label>
      <select [(ngModel)]="invoice.customerCompanyId" name="customerCompanyId">
        <option [ngValue]="null">انتخاب کنید</option>
        <option *ngFor="let c of customersCompany" [ngValue]="c.customerId">
          {{ c.companyName }}
        </option>
      </select>
    </div>

    <!-- جدول آیتم‌های فاکتور -->
    <h3>آیتم‌های فاکتور</h3>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>محصول</th>
            <th>تعداد</th>
            <th>بهای واحد</th>
            <th>مبلغ کل (قبل از تخفیف)</th>
            <th>تخفیف</th>
            <th>قیمت بعد از تخفیف</th>
            <th>مالیات ارزش افزوده</th>
            <th>مبلغ کل + مالیات</th>
            <th>عملیات</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of invoice.invoiceItems; let i = index">
            <td>
              <select [(ngModel)]="item.productId" name="product-{{i}}" required
                      (change)="onProductChange(item, item.productId)">
                <option [ngValue]="null">انتخاب محصول</option>
                <option *ngFor="let p of products" [ngValue]="p.id">{{ p.name }}</option>
              </select>
            </td>
            <td>
              <input type="number"
                     [(ngModel)]="item.quantity"
                     name="quantity-{{i}}"
                     required
                     min="1"
                     (input)="calculateTotal()">
            </td>
            <td>{{ item.unitPrice | number:'1.0-0' }} ریال</td>
            <td>{{ (item.quantity * item.unitPrice) | number:'1.0-0' }} ریال</td>
            <td>
              <!-- ورودی تخفیف -->
              <input type="number"
                     [(ngModel)]="item.discount"
                     name="discount-{{i}}"
                     min="0"
                     step="100"
                     (input)="calculateTotal()">
            </td>
            <td>{{ item.priceAfterDiscount | number:'1.0-0' }} ریال</td>
            <td>{{ item.vatAmount | number:'1.0-0' }} ریال</td>
            <td>{{ item.finalPrice | number:'1.0-0' }} ریال</td>
            <td>
              <button type="button" (click)="removeItem(i)">حذف</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <button type="button" (click)="addItem()">افزودن آیتم</button>

    <!-- پیوست‌ها -->
    <h3>پیوست‌ها</h3>
    <input type="file" (change)="onFileSelected($event)" multiple>
    <ul>
      <li *ngFor="let att of invoice.attachments; let i = index">
        {{ att.fileName }}
        <button type="button" (click)="removeAttachment(i)">حذف</button>
      </li>
    </ul>

    <!-- خلاصه مالی -->
    <h3>جمع کل بدون مالیات: {{ getTotalWithoutVAT() | number:'1.0-0' }} ریال</h3>
    <h3>جمع مالیات ارزش افزوده: {{ getTotalVAT() | number:'1.0-0' }} ریال</h3>
    <h3>جمع کل با مالیات: {{ calculateTotal() | number:'1.0-0' }} ریال</h3>

    <!-- دکمه ذخیره -->
    <button type="submit">
      {{ invoice.id ? 'ویرایش فاکتور' : 'ذخیره فاکتور' }}
    </button>
  </form>

  <!-- دکمه بازگشت -->
  <div class="actions">
    <button type="button" class="btn-back" (click)="goToList()">بازگشت به لیست فاکتورها</button>
  </div>
</div>

<div class="invoice-list">
  <h2>لیست فاکتورها</h2>

  <div class="filters">
    <button (click)="toggleFilters()">
      {{ filtersOpen ? 'بستن فیلترها' : 'نمایش فیلترها' }}
    </button>

    <div *ngIf="filtersOpen" class="filter-panel">
      <label>نوع مشتری:</label>
      <select [(ngModel)]="filterCustomerType" (change)="applyFilter()">
        <option value="All">همه</option>
        <option value="Individual">حقیقی</option>
        <option value="Company">حقوقی</option>
      </select>

      <label>جستجو:</label>
      <input type="text" [(ngModel)]="searchTerm" (input)="applyFilter()" placeholder="شماره یا نام مشتری">
    </div>
  </div>

  <div class="action-buttons">
    <button class="create-btn"
            *ngIf="hasPermission('invoice.create')"
            (click)="goToCreate()">
      افزودن فاکتور جدید
    </button>
  </div>


  <div class="table-wrapper" dir="rtl">
    <table class="invoice-table">
      <thead>
        <tr>
          <th>شماره فاکتور</th>
          <th>مشتری</th>
          <th>نوع فاکتور</th>
          <th>وضعیت</th>
          <th>تاریخ صدور</th>
          <th>تعداد روز اعتبار</th>
          <th>مبلغ بعد از تخفیف (ریال)</th>
          <th>مالیات ارزش افزوده (ریال)</th>
          <th>مبلغ کل با مالیات ارزش افزوده (ریال)</th>
          <th>پیوست‌ها</th>
          <th *ngIf="hasPermission('invoice.update') || hasPermission('invoice.delete')">عملیات</th>
          <th>چاپ</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let invoice of filteredInvoices">
          <td>{{ toPersianDigits(invoice.invoiceNumber) }}</td>
          <td>{{ getCustomerName(invoice) }}</td>
          <td>{{ getInvoiceTypeLabel(invoice.invoiceType) }}</td>
          <td>{{ getStatusLabel(invoice.status) }}</td>
          <td>{{ toJalali(invoice.issueDate) }}</td>
          <td>{{ toPersianDigits(getValidityDays(invoice)) }}</td>
          <td>{{ toPersianDigits(getInvoiceTotalAfterDiscount(invoice) | number:'1.0-0') }}</td>
          <td>{{ toPersianDigits(getInvoiceTotalVAT(invoice) | number:'1.0-0') }}</td>
          <td>{{ toPersianDigits(getInvoiceFinalTotal(invoice) | number:'1.0-0') }}</td>

          <td>
            <a class="attachment-icon" (click)="openAttachmentsModal(invoice)">
              <i class="fas fa-paperclip"></i>
            </a>
          </td>

          <td *ngIf="hasPermission('invoice.update') || hasPermission('invoice.delete')">
            <button *ngIf="hasPermission('invoice.update')" (click)="goToEdit(invoice.id!)">ویرایش</button>
            <button *ngIf="hasPermission('invoice.delete')" (click)="onDelete(invoice.id!)">حذف</button>
          </td>

          <td>
            <button (click)="printInvoice(invoice.id!)">چاپ</button>
          </td>
        </tr>

        <tr *ngIf="!filteredInvoices.length">
          <td colspan="12" style="text-align:center">هیچ فاکتوری یافت نشد.</td>
        </tr>
      </tbody>
    </table>
  </div>



  <div class="custom-modal" [class.show]="showAttachmentsModal">
    <div class="modal-backdrop" (click)="closeAttachmentsModal()"></div>
    <div class="custom-modal-dialog">
      <div class="modal-fixed-header">
        <h5>فایل‌های پیوست فاکتور</h5>
        <button class="close-modal-btn" (click)="closeAttachmentsModal()">&times;</button>
      </div>

      <div class="custom-modal-body" dir="rtl">
        <div *ngIf="selectedInvoiceAttachments?.length; else noFiles">
          <ul>
            <li *ngFor="let f of selectedInvoiceAttachments">
              <a [href]="f.fileUrl || getAttachmentUrl(f.filePath)" target="_blank">
                <i class="fas fa-file-alt"></i>
                {{ f.originalName || f.fileName || f.filePath?.split('/').pop() }}
              </a>
            </li>
          </ul>
        </div>

        <ng-template #noFiles>
          <p>هیچ فایلی موجود نیست.</p>
        </ng-template>
      </div>
    </div>
  </div>

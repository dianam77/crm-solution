<div style="text-align: right;">
  <button type="button" (click)="toggleForm()" *ngIf="canEdit">
    {{ isEditMode ? 'ویرایش مشتری' : 'ثبت مشتری جدید' }}
  </button>
</div>
<br />
<br />
<br />

<div *ngIf="showForm" class="modal-wrapper">
  <!-- پس‌زمینه تاریک -->
  <div class="modal-backdrop" (click)="toggleForm()"></div>

  <!-- باکس مودال -->
  <div class="modal">
    <!-- هدر ثابت -->
    <div class="modal-fixed-header">
      <h3>{{ isEditMode ? 'ویرایش مشتری' : 'فرم ساخت مشتری جدید' }}</h3>
      <span class="close-button" (click)="toggleForm()">×</span>
    </div>

    <!-- محتوای اسکرول شونده -->
    <div class="modal-body">
      <form [formGroup]="customerForm" (ngSubmit)="addCustomer()" class="add-customer-form">

        <!-- نام -->
        <div class="field-row">
          <label for="firstName">نام:</label>
          <input id="firstName" type="text" formControlName="firstName" />
        </div>
        <div *ngIf="customerForm.get('firstName')?.invalid && customerForm.get('firstName')?.touched" class="error">نام لازم است.</div>

        <!-- نام خانوادگی -->
        <div class="field-row">
          <label for="lastName">نام خانوادگی:</label>
          <input id="lastName" type="text" formControlName="lastName" />
        </div>
        <div *ngIf="customerForm.get('lastName')?.invalid && customerForm.get('lastName')?.touched" class="error">نام خانوادگی لازم است.</div>

        <!-- کد ملی -->
        <div class="field-row">
          <label for="nationalCode">کد ملی:</label>
          <input id="nationalCode" type="text" formControlName="nationalCode" maxlength="10" />
        </div>
        <div *ngIf="customerForm.get('nationalCode')?.errors?.['nationalCodeInvalid'] && customerForm.get('nationalCode')?.touched" class="error">
          {{ customerForm.get('nationalCode')?.errors?.['nationalCodeInvalid'] }}
        </div>

        <hr />

        <!-- ایمیل‌ها -->
        <div formArrayName="emails">
          <label>ایمیل‌ها:</label>
          <div *ngFor="let email of emails.controls; let i = index" [formGroupName]="i" class="email-block field-row">
            <input type="email" formControlName="emailAddress" placeholder="ایمیل" />
            <div *ngIf="email.get('emailAddress')?.invalid && email.get('emailAddress')?.touched" class="error">
              <div *ngIf="email.get('emailAddress')?.errors?.['required']">ایمیل لازم است.</div>
              <div *ngIf="email.get('emailAddress')?.errors?.['email']">ایمیل نامعتبر است.</div>
            </div>

            <select formControlName="emailType" required>
              <option value="" disabled>نوع ایمیل</option>
              <option *ngFor="let et of emailTypes" [value]="et.value">{{ et.label }}</option>
            </select>

            <label class="checkbox-label">
              اصلی
              <input type="checkbox" formControlName="isPrimary" />
            </label>

            <button *ngIf="emails.length > 1" type="button" (click)="removeEmailField(i)">حذف</button>
          </div>

          <button type="button" (click)="addEmailField()">افزودن ایمیل</button>
        </div>

        <hr />

        <!-- تلفن‌ها -->
        <div formArrayName="contactPhones">
          <label>تلفن‌ها:</label>
          <div *ngFor="let phone of contactPhones.controls; let i = index" [formGroupName]="i" class="phone-block field-row">
            <select formControlName="phoneType" required>
              <option value="" disabled>نوع تلفن</option>
              <option *ngFor="let pt of phoneTypes" [value]="pt.value">{{ pt.label }}</option>
            </select>
            <input type="text" formControlName="phoneNumber" placeholder="شماره تلفن" />

            <input *ngIf="phone.get('phoneType')?.value === 'work'" type="text" formControlName="extension" placeholder="داخلی" />

            <button *ngIf="contactPhones.length > 1" type="button" (click)="removePhoneField(i)">حذف</button>
          </div>

          <button type="button" (click)="addPhoneField()">افزودن تلفن</button>
        </div>

        <hr />

        <!-- آدرس‌ها -->
        <div formArrayName="addresses">
          <label>آدرس‌ها:</label>
          <div *ngFor="let address of addresses.controls; let i = index" [formGroupName]="i" class="address-block field-row address-row">
            <input type="text" formControlName="fullAddress" placeholder="آدرس کامل" />

            <select formControlName="provinceId" (change)="onProvinceChange(i)" required>
              <option value="">استان را انتخاب کنید</option>
              <option *ngFor="let p of provinces" [value]="p.provinceId">{{ p.name }}</option>
            </select>

            <select formControlName="cityId" required>
              <option value="">شهر را انتخاب کنید</option>
              <option *ngFor="let c of citiesMap[addresses.at(i).get('provinceId')?.value] || []" [value]="c.cityId">{{ c.name }}</option>
            </select>

            <input type="text" formControlName="postalCode" placeholder="کدپستی" maxlength="10" />

            <div class="error-message" *ngIf="getAddressControl(i, 'postalCode')?.invalid && (getAddressControl(i, 'postalCode')?.dirty || getAddressControl(i, 'postalCode')?.touched)">
              <small class="text-danger" *ngIf="getAddressControl(i, 'postalCode')?.errors?.['required']">کد پستی الزامی است.</small>
              <small class="text-danger" *ngIf="getAddressControl(i, 'postalCode')?.errors?.['pattern']">کد پستی باید دقیقاً ۱۰ رقم باشد.</small>
            </div>

            <select formControlName="addressType" required>
              <option value="">نوع آدرس</option>
              <option *ngFor="let at of addressTypes" [value]="at.value">{{ at.label }}</option>
            </select>

            <button *ngIf="addresses.length > 1" type="button" (click)="removeAddressField(i)">حذف</button>
          </div>

          <button type="button" (click)="addAddressField()">افزودن آدرس</button>
        </div>

        <hr />

        <button type="submit">
          {{ isEditMode ? 'ویرایش مشتری' : 'ثبت مشتری جدید' }}
        </button>

        <button type="button" (click)="toggleForm()">انصراف</button>
      </form>
    </div>
  </div>
</div>

<hr />

<!-- جدول مشتریان -->
<table class="table table-bordered table-striped rtl-table">
  <thead class="table-light">
    <tr>
      <th>شماره ردیف</th>
      <th>نام</th>
      <th>نام خانوادگی</th>
      <th>کد ملی</th>
      <th>ایمیل‌ها</th>
      <th>تلفن‌ها</th>
      <th>آدرس‌ها</th>
      <th *ngIf="canEdit">عملیات</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngIf="!customers || customers.length === 0">
      <td [attr.colspan]="canEdit ? 8 : 7" class="text-center">موردی یافت نشد.</td>
    </tr>
    <tr *ngFor="let customer of customers; let i = index">
      <td>{{ i + 1 }}</td>
      <td>{{ customer.firstName }}</td>
      <td>{{ customer.lastName }}</td>
      <td>{{ customer.nationalCode }}</td>
      <td>
        <ul style="padding-right: 0; list-style-type: none;">
          <li *ngFor="let e of customer.emails">
            {{ e.emailAddress }} ({{ getEmailTypeLabel(e.emailType) }})
          </li>
        </ul>
      </td>
      <td>
        <ul style="padding-right: 0; list-style-type: none;">
          <li *ngFor="let p of customer.contactPhones">
            {{ p.phoneNumber }} ({{ getPhoneTypeLabel(p.phoneType) }})
          </li>
        </ul>
      </td>
      <td>
        <ul style="padding-right: 0; list-style-type: none;">
          <li *ngFor="let addr of customer.addresses">
            <div>
              <strong>آدرس کامل:</strong> {{ addr.fullAddress }}<br>
              <strong>استان:</strong> {{ getProvinceName(addr.provinceId) }} (شناسه: {{ addr.provinceId }})<br>
              <strong>شهر:</strong> {{ getCityName(addr.provinceId, addr.cityId) }} (شناسه: {{ addr.cityId }})<br>
              <strong>کد پستی:</strong> {{ addr.postalCode }}<br>
              <strong>شناسه آدرس:</strong> {{ addr.addressId }}
            </div>
          </li>
        </ul>
      </td>
      <td *ngIf="canEdit">
        <button (click)="editCustomer(customer)" [disabled]="!canEdit">ویرایش</button>
        <button (click)="deleteCustomer(customer.customerId)" [disabled]="!canEdit">حذف</button>
      </td>
    </tr>
  </tbody>
</table>

<div class="container mt-4">

  <button class="btn btn-primary mb-3" (click)="showModal = true"
          *ngIf="hasPermission('customerinteraction.create')">
    تعامل جدید
  </button>

  <div class="custom-modal" [class.show]="showModal">
    <div class="modal-backdrop"></div>
    <div class="custom-modal-dialog">
      <div class="modal-fixed-header">
        <h5>{{ isEditMode ? 'ویرایش تعامل' : 'تعامل جدید' }}</h5>
        <button class="close-modal-btn" (click)="resetForm()">&times;</button>
      </div>

      <div class="custom-modal-body">
        <form [formGroup]="form" (ngSubmit)="submit()">

 
          <div class="form-row mb-2">
            <label>نوع تعامل</label>
            <select formControlName="interactionType" (change)="onInteractionTypeChange()" class="form-control">
              <option value="">انتخاب کنید</option>
              <option *ngFor="let t of interactionTypes" [ngValue]="t.value">{{ t.label }}</option>
            </select>
          </div>

          <div class="form-row d-flex gap-2 mb-2">
            <ng-persian-datepicker type="date" format="jYYYY/jMM/jDD">
              <input type="text" class="form-control" formControlName="startDateTime" placeholder="تاریخ شروع" />
            </ng-persian-datepicker>

            <input class="form-control"
                   [ngxTimepicker]="picker"
                   formControlName="startTime"
                   readonly
                   placeholder="انتخاب ساعت"
                   (input)="onTimeTextChange($event.target.value)">

            <ngx-material-timepicker #picker [format]="24"></ngx-material-timepicker>
          </div>


          <div class="form-row mb-2" *ngIf="isDurationEnabled()">
            <label>مدت زمان (دقیقه)</label>
            <input type="text"
                   formControlName="durationMinutes"
                   (input)="checkNumber($event); onDurationChange()"
                   class="form-control">
          </div>

          <div class="form-row mb-2" *ngIf="isDurationEnabled() && form.get('durationMinutes')?.value">
            <label>زمان پایان:</label>
            <div class="form-control bg-light">
              {{ toJalali(calculateEndDate()) }}
            </div>
          </div>

      
          <div class="form-row mb-2">
            <label>انتخاب مشتری</label>
            <div class="d-flex gap-3">
              <label><input type="radio" name="customerType" [checked]="selectedCustomerType==='individual'" (change)="selectCustomerType('individual')"> مشتری حقیقی</label>
              <label><input type="radio" name="customerType" [checked]="selectedCustomerType==='company'" (change)="selectCustomerType('company')"> مشتری حقوقی</label>
            </div>
          </div>

          <div class="form-row mb-2" *ngIf="selectedCustomerType==='individual'">
            <select class="form-control" formControlName="individualCustomerId">
              <option [ngValue]="null">-- انتخاب مشتری حقیقی --</option>
              <option *ngFor="let c of individualCustomers" [ngValue]="c.customerId">{{c.fullName}}</option>
            </select>
          </div>

          <div class="form-row mb-2" *ngIf="selectedCustomerType==='company'">
            <select class="form-control" formControlName="companyCustomerId">
              <option [ngValue]="null">-- انتخاب مشتری حقوقی --</option>
              <option *ngFor="let c of companyCustomers" [ngValue]="c.customerId">{{c.companyName}}</option>
            </select>
          </div>

          <div formArrayName="categoryProductGroups">
            <label class="fw-bold mb-2 d-block">دسته‌بندی و محصولات:</label>

            <div *ngFor="let group of categoryProductGroups.controls; let i = index" [formGroupName]="i" class="mb-3 border rounded p-2">

     
              <div class="form-row mb-2">
                <label>دسته‌بندی‌ها</label>
                <ng-select [items]="categories"
                           bindLabel="name"
                           bindValue="id"
                           [multiple]="true"
                           formControlName="categoryIds"
                           (change)="onCategoryChange(i)">
                </ng-select>
              </div>

              <div class="form-row mb-2">
                <label>محصولات / خدمات</label>
                <ng-select [items]="filteredProductsByGroup[i]"
                           bindLabel="name"
                           bindValue="id"
                           [multiple]="true"
                           formControlName="productIds">
                </ng-select>
              </div>


              <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeCategoryProductGroup(i)">
                حذف گروه
              </button>
            </div>

            <button type="button" class="btn btn-sm btn-outline-primary mt-2" (click)="addCategoryProductGroup()">
              + افزودن دسته/محصول دیگر
            </button>
          </div>


          <div class="form-row mb-2">
            <label>موضوع</label>
            <input type="text" class="form-control" formControlName="subject">
          </div>

          <div class="form-row mb-2">
            <label>توضیحات</label>
            <textarea class="form-control" formControlName="notes"></textarea>
          </div>


          <div class="form-row mb-2">
            <label>پیوست</label>
            <input type="file" #fileInput multiple style="display:none" (change)="onFileChange($event)">
            <button type="button" class="btn btn-sm btn-outline-primary mb-2" (click)="addFileInput(fileInput)">+ افزودن فایل</button>

            <div *ngIf="existingAttachments?.length">
              <h6>فایل‌های موجود:</h6>
              <div *ngFor="let f of existingAttachments; let i = index">
                <a [href]="getAttachmentUrl(f.filePath)" target="_blank">{{ f.originalName }}</a>
                <button type="button" class="btn btn-sm btn-danger ms-2" (click)="removeExistingAttachment(i)">حذف</button>
              </div>
            </div>

            <div *ngIf="currentAttachmentFiles?.length">
              <h6>فایل‌های جدید:</h6>
              <div *ngFor="let file of currentAttachmentFiles; let i = index">
                {{ file.originalName }}
                <button type="button" class="btn btn-sm btn-danger ms-2" (click)="removeNewAttachment(i)">حذف</button>
              </div>
            </div>

          </div>

 
          <div class="form-row d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-success" [disabled]="form.invalid">{{ isEditMode ? 'ویرایش' : 'ثبت' }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>


  <div class="table-scroll-wrapper mt-4">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>شماره ردیف</th>
          <th>نوع تعامل</th>
          <th>تاریخ شروع</th>
          <th>مدت زمان (دقیقه)</th>
          <th>تاریخ پایان</th>
          <th>موضوع</th>
          <th>مشتری</th>
          <th>توسط</th>
          <th>دسته‌بندی / محصول</th>
          <th>فایل پیوست</th>
          <th *ngIf="hasPermission('customerinteraction.update') || hasPermission('customerinteraction.delete')">
            عملیات
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let i of interactions; let idx = index">
          <td>{{ toPersianDigits(idx + 1) }}</td>
          <td>{{ getInteractionLabel(i.interactionType ?? undefined) }}</td>
          <td>{{ toJalali(i.startDateTime) }}</td>
          <td>{{ toPersianDigits(i.durationMinutes ?? '-') }}</td>
          <td>{{ toJalali(i.endDateTime ?? undefined) }}</td>
          <td>{{ i.subject || '-' }}</td>
          <td>{{ getCustomerDisplayName(i.customer) }}</td>
          <td>{{ i.performedBy || '-' }}</td>

          <td>
            <ng-container *ngIf="i.categoryName?.length || i.productName?.length; else noCategoryProduct">
              <a href="#" class="category-icon" (click)="openCategoryModal(i, $event)">
                <i class="fas fa-box-open"></i>
              </a>
            </ng-container>
            <ng-template #noCategoryProduct>-</ng-template>
          </td>

          <td>
            <ng-container *ngIf="i.attachments?.length; else noFile">
              <a href="#" class="attachment-icon" (click)="openAttachmentsModal(i, $event)">
                <i class="fas fa-paperclip"></i>
              </a>
            </ng-container>
            <ng-template #noFile>-</ng-template>
          </td>

          <td *ngIf="hasPermission('customerinteraction.update') || hasPermission('customerinteraction.delete')">
            <button (click)="editInteraction(i)"
                    class="btn btn-sm btn-primary"
                    *ngIf="hasPermission('customerinteraction.update')">
              ویرایش
            </button>

            <button (click)="deleteInteraction(i.id!)"
                    class="btn btn-sm btn-danger ms-2"
                    *ngIf="hasPermission('customerinteraction.delete')">
              حذف
            </button>
          </td>
        </tr>
      </tbody>

    </table>
  </div>
  <div class="custom-modal" [class.show]="showAttachmentsModal">
    <div class="modal-backdrop"></div>
    <div class="custom-modal-dialog">
      <div class="modal-fixed-header">
        <h5>فایل‌های پیوست</h5>
        <button class="close-modal-btn" (click)="showAttachmentsModal = false">&times;</button>
      </div>

      <div class="custom-modal-body">
        <div *ngIf="selectedAttachments?.length; else noFiles">
          <ul>
            <li *ngFor="let f of selectedAttachments">
              <a [href]="getAttachmentUrl(f.filePath)" target="_blank">
                <i class="fas fa-file-alt"></i>
                {{ f.originalName || f.filePath.split('/').pop() }}
              </a>
            </li>
          </ul>
        </div>

        <ng-template #noFiles>
          <p>هیچ فایلی موجود نیست.</p>
        </ng-template>
      </div>
    </div>
  </div>
  <div class="custom-modal" [class.show]="showCategoryModal">
    <div class="modal-backdrop"></div>
    <div class="custom-modal-dialog">
      <div class="modal-fixed-header">
        <h5>دسته‌بندی / محصولات</h5>
        <button class="close-modal-btn" (click)="showCategoryModal = false">&times;</button>
      </div>

      <div class="custom-modal-body">
        <div *ngIf="selectedCategoryProducts?.length; else noData" class="category-grid">
          <div *ngFor="let pair of selectedCategoryProducts" class="category-card">
            <strong class="category-title">{{ pair.category }}</strong>
            <ul class="products-list">
              <li *ngFor="let p of pair.products">{{ p }}</li>
            </ul>
          </div>
        </div>
        <ng-template #noData>
          <p>هیچ دسته‌بندی یا محصولی وجود ندارد.</p>
        </ng-template>
      </div>
    </div>
  </div>

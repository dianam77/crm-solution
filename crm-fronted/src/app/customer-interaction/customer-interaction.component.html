<div class="container mt-4">
  <button class="btn btn-primary mb-3" (click)="showModal = true">ุชุนุงูู ุฌุฏุฏ</button>
  
  <div class="custom-modal" [class.show]="showModal">
    <div class="modal-backdrop"></div>
    <div class="custom-modal-dialog">
      <div class="modal-fixed-header">
        <h5>{{ isEditMode ? 'ูุฑุงุด ุชุนุงูู' : 'ุชุนุงูู ุฌุฏุฏ' }}</h5>
        <button class="close-button" (click)="resetForm()">&times;</button>
      </div>
      <div class="custom-modal-body">
        <form [formGroup]="form" (ngSubmit)="submit()">
          <!-- ููุน ุชุนุงูู -->
          <div class="form-row mb-2">
            <label>ููุน ุชุนุงูู</label>
            <select formControlName="interactionType" (change)="onInteractionTypeChange()">
              <option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>
              <option *ngFor="let t of interactionTypes" [ngValue]="t.value">{{ t.label }}</option>

            </select>

     

          </div>

          <!-- ุฒูุงู ุดุฑูุน ู ุณุงุนุช -->
          <div class="form-row d-flex gap-2 mb-2">
            <ng-persian-datepicker type="date" format="jYYYY/jMM/jDD">
              <input type="text" class="form-control" formControlName="startDateTime" placeholder="ุชุงุฑุฎ ุดุฑูุน" />
            </ng-persian-datepicker>

            <input class="form-control"
                   [ngxTimepicker]="picker"
                   formControlName="startTime"
                   readonly
                   placeholder="ุงูุชุฎุงุจ ุณุงุนุช"
                   (input)="onTimeTextChange($event.target.value)">

            <ngx-material-timepicker #picker [format]="24"></ngx-material-timepicker>
          </div>

          <!-- ูุฏุช ุฒูุงู -->
          <div class="form-row mb-2" *ngIf="isDurationEnabled()">
            <label>ูุฏุช ุฒูุงู (ุฏููู)</label>
            <input type="text"
                   formControlName="durationMinutes"
                   (input)="checkNumber($event); onDurationChange()"
                   [disabled]="!isDurationEnabled()"
                   class="form-control">
          </div>

          <!-- ุฒูุงู ูพุงุงู -->
          <div class="form-row mb-2" *ngIf="isDurationEnabled() && form.get('durationMinutes')?.value">
            <label>ุฒูุงู ูพุงุงู:</label>
            <div class="form-control bg-light">
              {{ toJalali(calculateEndDate()) }}
            </div>
          </div>

          <!-- ุงูุชุฎุงุจ ูุดุชุฑ -->
          <div class="form-row mb-2">
            <label>ุงูุชุฎุงุจ ูุดุชุฑ</label>
            <div class="d-flex gap-3">
              <label><input type="radio" name="customerType" [checked]="selectedCustomerType==='individual'" (change)="selectCustomerType('individual')"> ูุดุชุฑ ุญูู</label>
              <label><input type="radio" name="customerType" [checked]="selectedCustomerType==='company'" (change)="selectCustomerType('company')"> ูุดุชุฑ ุญููู</label>
            </div>
          </div>

          <div class="form-row mb-2" *ngIf="selectedCustomerType==='individual'">
            <select class="form-control" formControlName="individualCustomerId">
              <option [ngValue]="null">-- ุงูุชุฎุงุจ ูุดุชุฑ ุญูู --</option>
              <option *ngFor="let c of individualCustomers" [ngValue]="c.customerId">{{c.fullName}}</option>
            </select>
          </div>

          <div class="form-row mb-2" *ngIf="selectedCustomerType==='company'">
            <select class="form-control" formControlName="companyCustomerId">
              <option [ngValue]="null">-- ุงูุชุฎุงุจ ูุดุชุฑ ุญููู --</option>
              <option *ngFor="let c of companyCustomers" [ngValue]="c.customerId">{{c.companyName}}</option>
            </select>
          </div>

          <!-- ููุถูุน ู ุชูุถุญุงุช -->
          <div class="form-row mb-2">
            <label>ููุถูุน</label>
            <input type="text" class="form-control" formControlName="subject">
          </div>

          <div class="form-row mb-2">
            <label>ุชูุถุญุงุช</label>
            <textarea class="form-control" formControlName="notes"></textarea>
          </div>

          <!-- ูพูุณุช -->
          <div class="form-row mb-2">
            <label>ูพูุณุช</label>
            <input type="file" #fileInput multiple style="display:none" (change)="onFileChange($event)">
            <button type="button" class="btn btn-sm btn-outline-primary mb-2" (click)="addFileInput(fileInput)">+ ุงูุฒูุฏู ูุงู</button>

            <div *ngIf="existingAttachmentPaths?.length">
              <h6>ูุงูโูุง ููุฌูุฏ:</h6>
              <div *ngFor="let path of existingAttachmentPaths; let i = index">
                <a [href]="getAttachmentUrl(path)" target="_blank">{{ path.split('/').pop() }}</a>
                <button type="button" class="btn btn-sm btn-danger ms-2" (click)="removeExistingAttachment(i)">ุญุฐู</button>
              </div>
            </div>

            <div *ngIf="currentAttachmentFiles?.length">
              <h6>ูุงูโูุง ุฌุฏุฏ:</h6>
              <div *ngFor="let file of currentAttachmentFiles; let i = index">
                {{ file.name }}
                <button type="button" class="btn btn-sm btn-danger ms-2" (click)="removeNewAttachment(i)">ุญุฐู</button>
              </div>
            </div>
          </div>

          <!-- ุฏฺฉููโูุง -->
          <div class="form-row d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-success" [disabled]="form.invalid">{{ isEditMode ? 'ูุฑุงุด' : 'ุซุจุช' }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ุฌุฏูู ุชุนุงููุงุช -->
  <table class="table table-bordered mt-4">
    <thead>
      <tr>
        <th>ุดูุงุฑู ุฑุฏู</th>
        <th>ููุน ุชุนุงูู</th>
        <th>ุชุงุฑุฎ ุดุฑูุน</th>
        <th>ูุฏุช ุฒูุงู (ุฏููู)</th>
        <th>ุชุงุฑุฎ ูพุงุงู</th>
        <th>ููุถูุน</th>
        <th>ูุดุชุฑ</th>
        <th>ุชูุณุท</th>
        <th>ูุงู ูพูุณุช</th>
        <th>ุนููุงุช</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let i of interactions; let idx = index">
        <td>{{ idx + 1 }}</td>
        <td>{{ getInteractionLabel(i.interactionType ?? undefined) }}</td>

        <td>{{ toJalali(i.startDateTime) }}</td>
        <td>{{ i.durationMinutes ?? '-' }}</td>
        <td>{{ toJalali(i.endDateTime ?? undefined) }}</td>
        <td>{{ i.subject || '-' }}</td>
        <td>{{ getCustomerDisplayName(i.customer) }}</td>
        <td>{{ i.performedBy || '-' }}</td>
        <td>
          <ng-container *ngIf="i.attachments?.length; else noFile">
            <div *ngFor="let f of i.attachments">
              <a [href]="getAttachmentUrl(f.filePath)" target="_blank">
                ๐ {{ f.filePath.split('/').pop() }}
              </a>
            </div>
          </ng-container>
          <ng-template #noFile>-</ng-template>
        </td>
        <td>
          <button (click)="editInteraction(i)" class="btn btn-sm btn-primary">ูุฑุงุด</button>
          <button (click)="deleteInteraction(i.id!)" class="btn btn-sm btn-danger ms-2">ุญุฐู</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

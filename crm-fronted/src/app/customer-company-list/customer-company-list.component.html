<div class="company-container">

  <!-- ุฏฺฉูู ููุงุด/ูพููุงู ฺฉุฑุฏู ููุฏุงู -->
  <button type="button" (click)="toggleCompanyForm()">
    {{ showCompanyForm ? 'ุจุณุชู ูุฑู' : 'ุงูุฒูุฏู ุดุฑฺฉุช ุฌุฏุฏ' }}
  </button>

  <!-- ููุฏุงู -->
  <div class="modal-wrapper" *ngIf="showCompanyForm">
    <div class="modal-backdrop" (click)="toggleCompanyForm()"></div>

    <div class="modal">

      <!-- ๐น ูุฏุฑ ุซุงุจุช ููุฏุงู -->
      <div class="modal-header">
        <h3>{{ isCompanyEditMode ? 'ูุฑุงุด ุดุฑฺฉุช' : 'ุงูุฒูุฏู ุดุฑฺฉุช ุฌุฏุฏ' }}</h3>
        <button type="button" class="modal-close-btn" (click)="toggleCompanyForm()">โ</button>
      </div>

      <!-- ๐น ุจุฏูู ูุงุจู ุงุณฺฉุฑูู -->
      <div class="modal-body">

        <form [formGroup]="companyForm" (ngSubmit)="saveCompany()">

          <!-- ูุงู ุดุฑฺฉุช -->
          <label>
            ูุงู ุดุฑฺฉุช:
            <input formControlName="companyName" />
          </label>

          <!-- ฺฉุฏ ุงูุชุตุงุฏ -->
          <label>
            ฺฉุฏ ุงูุชุตุงุฏ:
            <input formControlName="economicCode" />
          </label>

          <!-- ุดูุงุฑู ุซุจุช -->
          <label>
            ุดูุงุฑู ุซุจุช:
            <input formControlName="registerNumber" />
          </label>

          <!-- ุงููโูุง -->
          <div class="customer-relations-title">ุงููโูุง</div>

          <div formArrayName="emails">
            <div *ngFor="let email of companyEmails.controls; let i = index" [formGroupName]="i" class="email-row">
              <input type="email" formControlName="emailAddress" placeholder="ุงูู" />
              <select formControlName="emailType">
                <option value="" disabled>ููุน ุงูู</option>
                <option *ngFor="let type of emailTypes" [value]="type.value">{{ type.label }}</option>
              </select>
              <label class="checkbox-label">
                <input type="checkbox" formControlName="isPrimary" />
                ุงุตู
              </label>
              <button type="button" (click)="removeCompanyEmail(i)">ุญุฐู</button>
            </div>
            <button type="button" (click)="addCompanyEmail()">ุงูุฒูุฏู ุงูู</button>
          </div>

          <!-- ุดูุงุฑูโูุง -->
          <label>ุชูููโูุง:</label>
          <div formArrayName="contactPhones">
            <div *ngFor="let phone of companyPhones.controls; let i = index" [formGroupName]="i" class="phone-row">
              <input formControlName="phoneNumber" placeholder="ุดูุงุฑู" />
              <input *ngIf="phone.get('phoneType')?.value === 'work'" formControlName="extension" placeholder="ุฏุงุฎู" />
              <select formControlName="phoneType">
                <option *ngFor="let type of phoneTypes" [value]="type.value">{{ type.label }}</option>
              </select>
              <button type="button" (click)="removeCompanyPhone(i)">ุญุฐู</button>
            </div>
            <button type="button" (click)="addCompanyPhone()">ุงูุฒูุฏู ุดูุงุฑู</button>
          </div>

          <!-- ุขุฏุฑุณโูุง -->
          <label>ุขุฏุฑุณโูุง:</label>
          <div formArrayName="addresses">
            <div *ngFor="let addr of companyAddresses.controls; let i = index" [formGroupName]="i" class="address-row">
              <input formControlName="fullAddress" placeholder="ุขุฏุฑุณ ฺฉุงูู" />
              <select formControlName="provinceId" (change)="onCompanyProvinceChange(i)">
                <option value="">ุงูุชุฎุงุจ ุงุณุชุงู</option>
                <option *ngFor="let province of provinces" [value]="province.provinceId">{{ province.name }}</option>
              </select>
              <select formControlName="cityId" [disabled]="!addr.get('provinceId')?.value">
                <option value="">ุงูุชุฎุงุจ ุดูุฑ</option>
                <option *ngFor="let city of citiesMap[addr.get('provinceId')?.value] || []" [value]="city.cityId">{{ city.name }}</option>
              </select>
              <input formControlName="postalCode" placeholder="ฺฉุฏ ูพุณุช" />
              <select formControlName="addressType">
                <option *ngFor="let type of addressTypes" [value]="type.value">{{ type.label }}</option>
              </select>
              <button type="button" (click)="removeCompanyAddress(i)">ุญุฐู</button>
            </div>
            <button type="button" (click)="addCompanyAddress()">ุงูุฒูุฏู ุขุฏุฑุณ</button>
          </div>

          <!-- ุฑูุงุจุท -->
          <div formArrayName="customerCompanyRelations">
            <div class="customer-relations-title">ุฑุงุจุทู ุจุง ูุดุชุฑ ุญูู</div>
            <div *ngFor="let rel of companyRelations.controls; let i = index" [formGroupName]="i" class="relation-row">
              <select formControlName="individualCustomerId">
                <option value="">ุงูุชุฎุงุจ ูุฑุฏ</option>
                <option *ngFor="let customer of individualCustomers" [value]="customer.customerId">
                  {{ customer.fullName }}
                </option>
              </select>

              <select formControlName="relationType">
                <option value="">ุงูุชุฎุงุจ ููุน ุฑุงุจุทู</option>
                <option *ngFor="let type of relationTypes" [value]="type.value">
                  {{ type.label }}
                </option>
              </select>

              <button type="button" (click)="removeCompanyRelation(i)">ุญุฐู</button>
            </div>
            <button type="button" (click)="addCompanyRelation()">ุงูุฒูุฏู ุฑุงุจุทู</button>
          </div>

          <!-- ุฏฺฉููโูุง ุฐุฎุฑู -->
          <div class="modal-buttons">
            <button type="submit">{{ isCompanyEditMode ? 'ูุฑุงุด' : 'ุฐุฎุฑู' }}</button>
          </div>

        </form>
      </div> <!-- /modal-body -->
    </div> <!-- /modal -->
  </div> <!-- /modal-wrapper -->

<!-- ุฌุฏูู ุดุฑฺฉุชโูุง -->
<table class="table">
  <thead>
    <tr>
      <th>ุฑุฏู</th>
      <th>ูุงู ุดุฑฺฉุช</th>
      <th>ฺฉุฏ ุงูุชุตุงุฏ</th>
      <th>ุดูุงุฑู ุซุจุช</th>
      <th>ุขุฏุฑุณโูุง</th>
      <th>ุชูููโูุง</th>
      <th>ุงููโูุง</th>
      <th *ngIf="canEdit">ุนููุงุช</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngIf="!companies || companies.length === 0">
      <td [attr.colspan]="canEdit ? 8 : 7" class="text-center">ููุฑุฏ ุงูุช ูุดุฏ.</td>
    </tr>
    <tr *ngFor="let company of companies; let i = index">
      <td>{{ i + 1 }}</td>
      <td>{{ company.companyName }}</td>
      <td>{{ company.economicCode || '-' }}</td>
      <td>{{ company.registerNumber || '-' }}</td>
      <td>
        <ul>
          <li *ngFor="let addr of company.addresses">
            <strong>ุขุฏุฑุณ ฺฉุงูู:</strong> {{ addr.fullAddress }}<br>
            <strong>ุงุณุชุงู:</strong> {{ getProvinceName(addr.provinceId) }}<br>
            <strong>ุดูุฑ:</strong> {{ getCityName(addr.provinceId, addr.cityId) }}<br>
            <strong>ฺฉุฏ ูพุณุช:</strong> {{ addr.postalCode || '-' }}
          </li>
        </ul>
      </td>

      <td>
        <ul>
          <li *ngFor="let phone of company.contactPhones">
            {{ phone.phoneNumber }} {{ phone.extension ? 'ุฏุงุฎู ' + phone.extension : '' }}
          </li>
        </ul>
      </td>
      <td>
        <ul>
          <li *ngFor="let email of company.emails">
            {{ email.emailAddress }} {{ email.isPrimary ? '(ุงุตู)' : '' }}
          </li>
        </ul>
      </td>
      <td *ngIf="canEdit">
        <button type="button" (click)="editCompany(company)">ูุฑุงุด</button>
        <button type="button" (click)="deleteCompany(company.customerId!)">ุญุฐู</button>
      </td>
    </tr>
  </tbody>
</table>

</div>

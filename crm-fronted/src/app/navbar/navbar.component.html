
<div class="navbar" [class.collapsed]="navbarCollapsed">

  <button class="logout-btn" (click)="logout()" title="خروج">
    <i class="fas fa-power-off"></i>
  </button>

  <button class="toggle-btn" (click)="toggleSearch()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round"
         [style.transform]="searchVisible ? 'rotate(180deg)' : 'rotate(0deg)'">
      <line x1="4" y1="12" x2="20" y2="12"></line>
      <polyline points="14,6 20,12 14,18"></polyline>
    </svg>
  </button>

  <div class="search-box" *ngIf="searchVisible">
    <input type="text" placeholder="جستجو..." />
    <i class="fas fa-search search-icon"></i>
  </div>

 
  <div class="navbar-icons">
   
    <button class="icon-btn" (click)="toggleFullscreen()">
      <i class="fas fa-expand"></i>
    </button>
    
    <button class="icon-btn">
      <i class="fas fa-bell"></i>
      <span class="badge">3</span>
    </button>

    <button class="icon-btn"
            (click)="toggleReferralPanel()">
      <i class="fas fa-list"></i>
    </button>

   
<div class="icon-dropdown" *ngIf="hasPermission('chatmessages.getmessages') || hasPermission('chatmessages.getmy')">
  <button class="icon-btn" (click)="toggleMessages()">
    <i class="fas fa-envelope"></i>
    <span class="badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
  </button>

  <div class="dropdown-content" [class.open]="messagesOpen">
    
    <div class="section">
      <div class="section-header" style="text-align:center">پیام‌ها</div>

      <div *ngFor="let msg of visibleMessages" class="message-item" (click)="markAsRead(msg)">
        <div class="message-main">
          <input *ngIf="hasPermission('chatmessages.hidemessage') || hasPermission('chatmessages.delete')"
                 type="checkbox"
                 [(ngModel)]="msg.selected"
                 (click)="$event.stopPropagation()" />
          <div class="message-text">
            <div class="message-sender">{{ msg.senderName }}</div>
            <div class="message-content">{{ msg.content | slice:0:40 }}...</div>
          </div>



        </div>
        <div class="message-footer">
          <small class="date-rtl">{{ toJalali(msg.createdAt) }}</small>


          <span *ngIf="!msg.isReadByCurrentUser && msg.receiverIds.includes(currentUser?.id!)"
                class="unread-dot"></span>
        </div>
      </div>

      <div *ngIf="visibleMessages.length === 0" class="empty">هیچ پیامی وجود ندارد</div>

      <div class="clear-messages" *ngIf="hasPermission('chatmessages.hidemessage') || hasPermission('chatmessages.delete')">
        <button type="button" (click)="deleteSelectedMessages()" [disabled]="!hasSelectedMessages">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>

   
    <div class="section" *ngIf="hasPermission('chatmessages.sendmessage')">
      <div class="toggle-header" (click)="toggleReceiverList()">

        <span class="arrow">{{ receiversOpen ? '▲' : '▼' }}</span>
        گیرنده‌ها
      </div>
      <div class="user-list" *ngIf="receiversOpen">
        <ng-container *ngFor="let user of users">
          <label *ngIf="user.id !== currentUser?.id">
            <input type="checkbox"
                   [checked]="currentReceiverIds.includes(user.id)"
                   (change)="onCheckboxChange($event, user.id)" />
            {{ user.userName }}
          </label>
        </ng-container>
      </div>
    </div>

   
    <div class="section send-message" *ngIf="hasPermission('chatmessages.sendmessage')">
      <button type="button" (click)="sendMessage()">ارسال</button>
      <input type="text" [(ngModel)]="newMessageContent" placeholder="پیام جدید..." />

    </div>
  </div>
</div>



   
    <button class="icon-btn" (click)="toggleTheme()">
      <i class="fas" [ngClass]="darkMode ? 'fa-sun' : 'fa-moon'"></i>
    </button>

    <div class="profile-dropdown" *ngIf="currentUser" class="icon-btn">
   
      <button class="profile-btn" (click)="toggleProfileDropdown()">
        <span class="username">{{ currentUser.userName }}</span>
        <span class="caret">&#9662;</span>
      </button>

      
      <div class="dropdown-content" [class.show]="profileDropdownOpen">
        <div class="profile-info" dir="rtl">

          
          <div *ngIf="!editMode && !passwordEditMode">
            <p><strong>نام کاربری:</strong> {{ currentUser.userName }}</p>
            <p><strong>ایمیل:</strong> {{ currentUser.email || 'ثبت نشده' }}</p>
            <p><strong>نقش:</strong> {{ currentUser.role || 'تعریف نشده' }}</p>

            <div style="display: flex; gap: 10px; margin-top: 8px;">
              <button (click)="startEdit()" title="ویرایش اطلاعات">
                <i class="fas fa-user-edit"></i>
              </button>
              <button  (click)="startPasswordEdit()" title="تغییر رمز عبور">
                <i class="fas fa-lock"></i>
              </button>
            </div>
          </div>

          <div *ngIf="editMode" class="edit-section">
            <input [(ngModel)]="editableUserName" placeholder="نام کاربری جدید" />
            <input [(ngModel)]="editableEmail" placeholder="ایمیل جدید" type="email" />

            <div class="password-actions">
              <button class="save" (click)="saveProfileChanges()">✔</button>
              <button class="cancel" (click)="cancelEdit()">✖</button>
            </div>
          </div>

      
          <div *ngIf="passwordEditMode" style="margin-top: 10px;">
            <div style="position: relative; display: inline-block; width: 100%;">
              <input [(ngModel)]="newPassword"
                     [type]="passwordVisible ? 'text' : 'password'"
                     placeholder="رمز عبور جدید"
                     style="
              width: 100%;
              padding: 8px 35px 8px 10px;
              border-radius: 6px;
              border: 1px solid #ccc;
              font-size: 14px;
            " />
         
              <span style="
              position: absolute;
              top: 50%;
              right: 10px;
              transform: translateY(-50%);
              cursor: pointer;
            ">
                <ng-container *ngIf="passwordVisible; else eyeOff">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none"
                       stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                       (click)="passwordVisible = false">
                    <path d="M1 9s3-5 8-5 8 5 8 5-3 5-8 5-8-5-8-5z" />
                    <circle cx="9" cy="9" r="2" />
                  </svg>
                </ng-container>
                <ng-template #eyeOff>
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none"
                       stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                       (click)="passwordVisible = true">
                    <path d="M17.94 17.94 1.06 1.06" />
                    <path d="M10.58 10.58A2 2 0 0 1 8.41 8.41" />
                    <path d="M9 5c3.31 0 6.13 2.09 7.5 5-0.27 0.6-0.62 1.16-1.04 1.66" />
                    <path d="M6.36 6.36C5.04 7.15 3.93 8.42 3 10c1.37 2.91 4.19 5 7.5 5 1.5 0 2.92-0.43 4.11-1.17" />
                  </svg>
                </ng-template>
              </span>
            </div>

            <div class="password-actions" style="margin-top: 8px;">
              <button class="save" (click)="submitPasswordChange()">✔</button>
              <button class="cancel" (click)="cancelPasswordEdit()">✖</button>
            </div>

            <div *ngIf="newPassword && !isPasswordValid()" style="color:red; margin-top:5px; font-size: 13px;">
              رمز عبور باید حداقل یک حرف بزرگ و یک حرف کوچک داشته باشد.
            </div>
          </div>

        </div>
      </div>
    </div>






  </div>


<div class="referral-panel"
     *ngIf="hasPermission('userreferral.getall') || hasPermission('userreferral.getmyreferrals')"
     [class.visible]="referralPanelVisible"
     dir="rtl">


  <div class="panel-header">
    <h2>ارجاعات شما</h2>
    <button class="close-btn" (click)="referralPanelVisible = false">&times;</button>
  </div>

  <button class="btn-add"
          *ngIf="hasPermission('userreferral.create')"
          (click)="openCreateModal()">
    ایجاد ارجاع جدید
  </button>


  <div *ngIf="showCreateForm" class="create-form">
    <div class="form-header">
      <h3>{{ isEditMode ? 'ویرایش ارجاع' : 'ایجاد ارجاع جدید' }}</h3>
      <button class="close-btn" (click)="resetForm()">&times;</button>
    </div>

    <form (ngSubmit)="saveReferral()">
      <div class="form-group">
        <label>ارجاع دهنده</label>
        <span class="current-user">{{ currentUser?.userName || 'در حال بارگذاری...' }}</span>
      </div>

      <div class="form-group">
        <label>ارجاع گیرنده</label>
        <select [(ngModel)]="newReferral.assignedToId" name="assignedToId" required>
          <option *ngFor="let user of users" [ngValue]="user.id" [hidden]="user.id === currentUser?.id">
            {{ user.userName }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>توضیحات</label>
        <textarea [(ngModel)]="newReferral.notes" name="notes"></textarea>
      </div>

      <div class="form-group">
        <label>اولویت</label>
        <select [(ngModel)]="newReferral.priority" name="priority">
          <option [ngValue]="priorityEnum.Low">کم</option>
          <option [ngValue]="priorityEnum.Medium">متوسط</option>
          <option [ngValue]="priorityEnum.High">زیاد</option>
        </select>
      </div>

      <button type="submit" class="btn-submit">
        {{ isEditMode ? 'ذخیره تغییرات' : 'ارسال' }}
      </button>
    </form>
  </div>

  <hr>

 
  <div class="referral-cards">
    <div class="referral-card" *ngFor="let r of referrals">
      <div class="card-header">
        <span><strong>ارجاع دهنده:</strong> {{ r.assignedByName }}</span>
        <span><strong>ارجاع گیرنده:</strong> {{ r.assignedToName }}</span>
      </div>

      <div class="card-body">
        <p><strong>اولویت:</strong> {{ priorityLabels[r.priority] }}</p>

        <ng-container *ngIf="hasPermission('userreferral.updatestatus'); else readOnlyStatus">
          <label><strong>وضعیت:</strong></label>
          <select [(ngModel)]="r.status" (change)="updateReferralStatus(r)">
            <option [ngValue]="statusEnum.Pending">در انتظار</option>
            <option [ngValue]="statusEnum.Accepted">قبول شده</option>
            <option [ngValue]="statusEnum.Rejected">رد شده</option>
            <option [ngValue]="statusEnum.Completed">تکمیل شده</option>
          </select>
        </ng-container>

       
        <ng-template #readOnlyStatus>
          <p><strong>وضعیت:</strong> {{ statusLabels[r.status] }}</p>
        </ng-template>

        <p><strong>توضیحات:</strong> {{ r.notes || '-' }}</p>
      </div>



      <div class="card-actions">
        <button *ngIf="hasPermission('userreferral.update')" (click)="openEditModal(r)">ویرایش</button>
        <button *ngIf="hasPermission('userreferral.delete')" (click)="deleteReferral(r)">حذف</button>
      </div>
    </div>
  </div>
</div>
